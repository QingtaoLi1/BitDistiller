description: Simple Amulet job on Singularity

target:
  service: sing
  name: msrresrchvc
  workspace_name: dca-singularity

environment:
  image: amlt-sing/acpt-torch2.5.0-py3.10-cuda12.4-ubuntu22.04
  setup:
    - pwd
    - sudo apt-get update
    - sudo apt-get install -y vim
    - pip install uv
    - uv venv venv_bd --python 3.11
    - source venv_bd/bin/activate
    - uv pip install --upgrade pip setuptools packaging wheel ninja

    - uv pip install torch==2.5.1 torchvision==0.20.1 torchaudio==2.5.1
    - cd /scratch/amlt_code
    - uv pip install -r ./requirement_20250507_transformers_4.51.3.txt
    - uv pip install flash-attn==2.7.4.post1 --no-build-isolation
    - uv pip install vllm==0.8.5.post1 bitsandbytes

    - echo -e "alias ll='ls -al'" >> ~/.bashrc

storage:
  input:
    storage_account_name: dcasingularity4556773921
    container_name: qingtaoli
    mount_dir: /mnt/input
  output:
    storage_account_name: dcasingularity4556773921
    container_name: qingtaoli
    mount_dir: /mnt/output
  external:
    storage_account_name: dcasingularity4556773921
    container_name: qingtaoli
    mount_dir: /mnt/external

code:
  # local directory of the code. this will be uploaded to the server.
  # $CONFIG_DIR is expanded to the directory of this config file
  local_dir: ./

data:
  storage_id: external


jobs:
- name: bd_test_qwen3_A100
  sku: NC_A100_v4:G4
  identity: managed
  submit_args:
    env:
      _AZUREML_SINGULARITY_JOB_UAI: "/subscriptions/656a79af-6a27-4924-ad92-9221860e3bba/resourceGroups/dca-core/providers/Microsoft.ManagedIdentity/userAssignedIdentities/dca-core-identity"
  command:
    - huggingface-cli login --token <hf_token>
    - cd test/general
    - export CKPT_DIR=/mnt/external/checkpoints/Qwen/Qwen3-8B/1b-random-r0.5_cakld_ctx4096/checkpoint-400/
    - CUDA_VISIBLE_DEVICES=0 nohup python llm_eval.py --model $$CKPT_DIR --eval_tasks hendrycksTest-* --test_set --num_fewshot 5 --bits 2 --group_size 64 --quant_type int > $$CKPT_DIR/MMLU.log 2>&1 &
    - pid1=$$!
    - CUDA_VISIBLE_DEVICES=1 nohup python llm_eval.py --model $$CKPT_DIR --eval_tasks arc_challenge,winogrande,hellaswag,piqa --test_set --num_fewshot 0 --bits 2 --group_size 64 --quant_type int > $$CKPT_DIR/arc.log 2>&1 &
    - pid2=$$!
    - export CKPT_DIR=/mnt/external/checkpoints/Qwen/Qwen3-8B/1b-random-r0.5_cakld_ctx4096/checkpoint-800/
    - CUDA_VISIBLE_DEVICES=2 nohup python llm_eval.py --model $$CKPT_DIR --eval_tasks hendrycksTest-* --test_set --num_fewshot 5 --bits 2 --group_size 64 --quant_type int > $$CKPT_DIR/MMLU.log 2>&1 &
    - pid3=$$!
    - CUDA_VISIBLE_DEVICES=3 nohup python llm_eval.py --model $$CKPT_DIR --eval_tasks arc_challenge,winogrande,hellaswag,piqa --test_set --num_fewshot 0 --bits 2 --group_size 64 --quant_type int > $$CKPT_DIR/arc.log 2>&1 &
    - pid4=$$!
    - wait $$pid1 $$pid2 $$pid3 $$pid4
  tags: ["Debug:True"]
  priority: High
  azml_int: True
